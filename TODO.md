# 実装進捗とTODOリスト

## 完了した実装

### ✅ 基本構造
- [x] 型定義の更新（OAuth、暗号化関連）
- [x] 暗号化サービス（CryptoService）の実装
- [x] OAuth サービス（OAuthService）の実装
- [x] Sheets サービスの拡張（createKintaiSpreadsheet）
- [x] 新しいコマンドの Discord 登録（setup, status, reset）

### ✅ Discord コマンド
- [x] `/setup` コマンドのハンドラ実装
- [x] `/status` コマンドのハンドラ実装  
- [x] `/reset` コマンドのハンドラ実装
- [x] OAuth コールバック処理の更新

### ✅ 設定とドキュメント
- [x] README の更新（Bot対応版）
- [x] コマンド登録スクリプトの更新

## 🚧 未完了・要修正項目

### 高優先度

#### 1. 型エラーの修正
- [ ] ServerConfigService の EncryptionUtil → CryptoService 移行
- [ ] DiscordCommandService のコンストラクタ修正（環境変数追加）
- [ ] 各種メソッドシグネチャの整合性確保

#### 2. 新方式の勤怠記録実装
- [ ] サーバー設定を使った Google Sheets 直接アクセス
- [ ] 暗号化されたトークンの復号と使用
- [ ] トークンリフレッシュ機能
- [ ] 既存 GAS システムとの統合または移行

#### 3. エラーハンドリング
- [ ] OAuth エラーの詳細処理
- [ ] トークン期限切れ時の自動リフレッシュ
- [ ] Google API エラーの適切な処理
- [ ] ネットワークエラーのリトライ機能

### 中優先度

#### 4. セキュリティ強化
- [ ] Discord 権限チェックの改善（簡易版から正式版へ）
- [ ] CSRF 対策の実装確認
- [ ] 暗号化キーのローテーション機能

#### 5. 機能拡張
- [ ] 月別シート自動作成機能
- [ ] データ移行ツール（GAS → 新方式）
- [ ] 統計機能（月間勤務時間など）

#### 6. UI/UX 改善
- [ ] OAuth 認証画面のデザイン改善
- [ ] エラーメッセージの多言語対応
- [ ] レスポンシブデザインの実装

### 低優先度

#### 7. 運用機能
- [ ] ログ出力の改善
- [ ] 監視とアラート機能
- [ ] 設定バックアップ機能

#### 8. テスト
- [ ] 単体テストの実装
- [ ] 統合テストの実装
- [ ] E2E テストの実装

## 📋 次のアクション項目

### 即座に必要
1. **型エラーの修正**
   ```bash
   cd /Users/k24083kk/development/kintai-discord-v2
   bun run tsc --noEmit
   ```
   すべての TypeScript エラーを解決

2. **DiscordCommandService の修正**
   - コンストラクタにOAuthService、CryptoServiceを追加
   - 新しいコマンドハンドラメソッドのプロパティを正しく初期化

3. **ServerConfigService の完全移行**
   - EncryptionUtil の代わりに CryptoService を使用
   - 既存の暗号化ロジックを新しい方式に合わせて修正

### 短期目標（1週間以内）
1. **基本動作確認**
   - `/setup` コマンドの動作テスト
   - OAuth フローの動作確認
   - スプレッドシート作成の確認

2. **統合テスト**
   - 新しい方式での `/start` と `/end` の実装
   - 既存システムとの並行動作確認

### 中期目標（1ヶ月以内）
1. **完全移行**
   - GAS システムからの脱却
   - 直接 Google Sheets API の使用
   - パフォーマンス最適化

2. **リリース準備**
   - ドキュメント完成
   - エラーハンドリング強化
   - セキュリティ監査

## 🔧 技術的な考慮事項

### アーキテクチャの変更点
1. **GAS → Sheets API 直接**
   - レイテンシ改善
   - 依存関係の削減
   - より柔軟な認証方式

2. **暗号化方式**
   - Web Crypto API の使用
   - サーバー別トークン分離
   - セキュアな鍵管理

3. **認証フロー**
   - Discord のみで完結する設定
   - OAuth 2.0 による適切な権限管理
   - リフレッシュトークンによる長期利用

### パフォーマンス考慮事項
1. **API コール最適化**
   - バッチ処理の実装
   - 適切なキャッシュ戦略
   - レート制限への対応

2. **ユーザー体験**
   - 高速なレスポンス
   - エラー時の分かりやすいメッセージ
   - モバイル対応

## 💡 実装のポイント

### 重要な設計判断
1. **後方互換性**: 既存のGASシステムと並行動作可能
2. **段階的移行**: 機能ごとに順次新方式へ移行
3. **セキュリティファースト**: 暗号化とアクセス制御を最優先
4. **スケーラビリティ**: 多数のサーバーでの利用を想定

### 品質保証
1. **型安全性**: TypeScript の strict モードを活用
2. **エラーハンドリング**: 想定されるすべてのエラーケースに対応
3. **テスト**: 重要な機能については自動テストを実装
4. **ドキュメント**: 利用者と開発者両方に分かりやすい説明
