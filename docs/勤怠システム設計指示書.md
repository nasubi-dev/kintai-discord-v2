### **Discord 勤怠管理ボット 開発要件定義書 (v1.1 - Hono 利用)**

#### 1. プロジェクト概要

Discord のスラッシュコマンドを用いて勤怠を打刻し、その記録を Google スプレッドシートに月別のシートで管理する Bot を開発する。Bot のロジックは**Hono フレームワークを利用して**Cloudflare Workers 上で実装し、スプレッドシートの操作は Google Apps Script (GAS) で行う。

- **目的:** Discord 上での活動や作業時間を手軽に記録・管理する。
- **主要技術スタック:**
  - **ボットロジック:** Cloudflare Workers (**TypeScript, Hono フレームワーク**)
  - **スプレッドシート操作:** Google Apps Script (GAS)
  - **データベース:** Google Spreadsheet

---

#### 2. アーキテクチャ

現在の実装では Cloudflare Worker 内の処理が Hono によって構造化され、重複チェック機能として Cloudflare KV を活用しています。

コード スニペット

```
graph TD
    subgraph Discord
        User[Discord User] -- /start, /end --> API{Discord API}
    end

    subgraph "Cloudflare (Hono + KV)"
        API -- Webhook --> Worker[Hono App on Cloudflare]
        Worker <--> KV[Cloudflare KV Store]
    end

    subgraph Google
        Worker -- fetch(JSON) --> GAS[GAS Web App]
        GAS -- R/W --> Sheet[Google Spreadsheet]
    end

    Worker -- Ephemeral Msg etc. --> API
    API -- Bot Response --> User
```

1. **Hono App on Cloudflare:** Discord からの Webhook を単一のエンドポイントで受け取り、Hono の**ミドルウェア**でリクエスト署名を検証。**ルーティング**機能でコマンドを捌き、**Cloudflare KV での重複チェック**後に GAS を呼び出す。Discord への応答も Hono のレスポンスヘルパー (`c.json`) を使用して生成する。
2. **Cloudflare KV Store:** 勤怠の重複チェック用の高速ストレージ。開始記録の有無を管理し、24 時間の TTL で自動クリーンアップを行う。
3. **GAS Web App:** Worker からの指示に基づき、スプレッドシートの読み書きを行う。月次シートの確認・作成、勤怠データの記録、労働時間の計算など、データ操作の全てを担当する。重複チェックは KV 側で実施済みのため、データの永続化に専念する。

---

#### 3. 機能要件

| ID       | 機能名                 | 詳細                                                                                                                   |
| :------- | :--------------------- | :--------------------------------------------------------------------------------------------------------------------- |
| **FR-1** | **勤怠開始**           | `/start` コマンドを実行すると、実行者の ID、プロジェクト名、現在時刻を開始時刻としてスプレッドシートに記録する。       |
| **FR-2** | **勤怠終了**           | `/end` コマンドを実行すると、該当する開始記録を探し、現在時刻を終了時刻として記録する。                                |
| **FR-3** | **労働時間通知**       | `/end` コマンド成功時、その回の労働時間を計算し、コマンド実行者にのみ見えるメッセージ（Ephemeral Message）で通知する。 |
| **FR-4** | **プロジェクト名記録** | コマンドが実行されたチャンネルの名前を「プロジェクト名」として記録する。                                               |
| **FR-5** | **月別シート管理**     | 勤怠記録は、実行月ごとに分けられたシートに書き込む。シート名は `YYYY-MM` 形式（例: `2025-06`）とする。                 |
| **FR-6** | **シート自動作成**     | 該当月のシートが存在しない場合、ヘッダー付きの新しいシートを自動で作成する。                                           |
| **FR-7** | **チャンネル制限**     | 指定されたチャンネル以外でコマンドが実行された場合、処理を中断し、エラーメッセージを本人にのみ通知する。               |
| **FR-8** | **重複打刻防止**       | KV ストレージを使用して高速な重複チェックを実行。既に開始している勤務がある場合は処理を中断する。                      |
| **FR-9** | **自動クリーンアップ** | KV ストレージの勤怠記録は 24 時間の TTL で自動削除され、システムのメンテナンス負荷を軽減する。                         |

機能的な要件は、フレームワークの利用によって変更されません。FR-1 から FR-7 までの内容は前回の定義書と同様です。

---

#### 4. 詳細仕様

##### 4.1. データ構造 (Google Spreadsheet)

各月次シート（例: `2025-06`）は、以下の列を持つ必要があります。

| 列ヘッダー       | データ型 | 説明                                                               |
| :--------------- | :------- | :----------------------------------------------------------------- |
| `プロジェクト名` | string   | コマンドが実行されたチャンネル名。                                 |
| `ユーザー名`     | string   | コマンド実行者の Discord ユーザー名。                              |
| `差分`           | string   | 労働時間。 (例: `8時間30分15秒`)                                   |
| `開始時刻`       | datetime | 勤務開始時刻。(yyyy/MM/dd HH:mm:ss 形式)                           |
| `終了時刻`       | datetime | 勤務終了時刻。(yyyy/MM/dd HH:mm:ss 形式)                           |
| `channel_id`     | string   | Discord チャンネル ID。トレーサビリティ確保用。                    |
| `discord_id`     | string   | Discord ユーザー ID。ユーザー名変更に対応。                        |
| `uuid`           | string   | 各勤怠記録を一意に特定する ID。(GAS の`Utilities.getUuid()`で生成) |

##### 4.1.1. KV ストレージ構造

重複チェック用の Cloudflare KV は以下の構造を持ちます。

| キー形式               | 値の構造                                                                                          | TTL     |
| :--------------------- | :------------------------------------------------------------------------------------------------ | :------ |
| `{userId}:{channelId}` | `{ startTime: string, uuid: string, username: string, channelName: string, projectName: string }` | 24 時間 |

**例:**

- キー: `123456789012345678:987654321098765432`
- 値: `{ "startTime": "2025-06-25T09:00:00.000Z", "uuid": "abc123-def456-...", "username": "user123", "channelName": "general", "projectName": "general" }`

##### 4.2. コマンド仕様

- **/start**
  - **入力:** (引数なし)
  - **処理:**
    1. **KV 重複チェック**: `{userId}:{channelId}` キーで既存記録を確認 (FR-8)。存在する場合はエラーを返す。
    2. `YYYY-MM`形式の当月シートが存在するか確認。なければヘッダー付きで作成 (FR-6)。
    3. 現在の行に、`[プロジェクト名, ユーザー名, "", 開始時刻, "", チャンネルID, ユーザーID, UUID]` を追加して記録 (FR-1)。
    4. **KV 記録保存**: 重複チェック用の記録を KV に 24 時間 TTL で保存 (FR-9)。
  - **応答 (全員に見える):** `✅ 勤務を開始しました。`
- **/end**
  - **入力:** (引数なし)
  - **処理:**
    1. **KV 存在チェック**: `{userId}:{channelId}` キーで開始記録を確認。存在しない場合はエラーを返す。
    2. 当月シート内で、コマンド実行者のユーザー ID と一致し、かつ「終了時刻」が空の最新レコードを検索する。
    3. 見つかった場合、その行の「終了時刻」セルに現在時刻を記録する (FR-2)。
    4. 「開始時刻」と「終了時刻」の差を計算し、「差分」セルに書き込む。
    5. **KV 記録削除**: 重複チェック用の記録を KV から削除。
  - **応答 (全員に見える):** `✅ 勤務を終了しました。お疲れ様でした。**労働時間:** XX時間YY分ZZ秒` (FR-3)

##### 4.3. エラーハンドリング

- **チャンネル制限 (FR-7):**
  - **場所:** Cloudflare Worker 側で処理。
  - **条件:** コマンドが実行されたチャンネルの ID が、許可リストに含まれていない場合。
  - **応答 (本人にのみ見える):** `❌ このコマンドは指定された勤怠管理チャンネルでのみ使用できます。`
- **シート自動作成 (FR-6):**
  - **場所:** GAS 側で処理。
  - **条件:** `/start` コマンド実行時に、`YYYY-MM`形式のシートが存在しない場合。
  - **処理:** 新しいシートを作成し、1 行目に 4.1. で定義したヘッダーを書き込む。処理はそのまま続行する。
- **二重打刻防止 (FR-8):**
  - **場所:** Cloudflare Worker (KV) 側で処理。
  - **条件:** `/start` 実行時に、同ユーザー・同チャンネルでの KV 記録が既に存在する場合。
  - **応答 (本人にのみ見える):** `❌ 前回の勤務が終了されていません。先に /end コマンドを実行してください。`
- **未開始勤務終了防止:**
  - **場所:** Cloudflare Worker (KV) 側で処理。
  - **条件:** `/end` 実行時に、同ユーザー・同チャンネルでの KV 記録が存在しない場合。
  - **応答 (本人にのみ見える):** `❌ 開始されていない勤務を終了することはできません。先に /start コマンドを実行してください。`

データ構造、コマンドの具体的な動き、エラーハンドリングのロジックなど、仕様に関する項目は前回の定義書と同様です。

---

#### 5. Hono 利用時の実装指針

Hono フレームワークを利用した実装の具体的な進め方と構造を示します。

##### 5.1. プロジェクトセットアップ

プロジェクトでは Bun をパッケージマネージャーとして使用し、以下の構成で開発を行います。

```bash
bun create hono@latest my-discord-bot --template cloudflare-workers
```

主要な開発コマンド：

- 開発サーバー: `bun run dev`
- デプロイ: `bun run deploy`
- 型チェック: `bun run cf-typegen`
- TypeScript コンパイル: `bun run tsc --noEmit`

##### 5.2. 基本的なコード構造 (`src/index.ts`)

`index.ts`ファイルは以下のような構造になります。

TypeScript

```typescript
import { Hono } from "hono";
import {
  Bindings,
  DiscordInteraction,
  InteractionType,
  InteractionResponseType,
} from "./types";
import { verifyDiscordRequest, isTimestampValid } from "./utils";
import { DiscordCommandService } from "./discord-service";

const app = new Hono<{ Bindings: Bindings }>();

// Discord インタラクション処理
app.post("/api/interactions", async (c) => {
  // 署名検証と処理ロジック
  // ...
});

export default app;
```

##### 5.3. リクエスト検証 (署名検証)

Discord からのリクエストが正当であることを確認する署名検証ロジックは、メインのエンドポイント内で直接処理されます。これにより、全てのインタラクション処理の前に必ず検証が実行されることを保証できます。

```typescript
// リクエストボディを取得
const rawBody = await c.req.text();

// 署名検証用のリクエストオブジェクトを作成
const verificationRequest = new Request(c.req.url, {
  method: "POST",
  headers: {
    "x-signature-ed25519": signature,
    "x-signature-timestamp": timestamp,
    "content-type": "application/json",
  },
  body: rawBody,
});

// Discord署名を検証
const isValid = await verifyDiscordRequest(
  verificationRequest,
  c.env.DISCORD_PUBLIC_KEY
);
```

##### 5.4. ルーティングと処理

Discord からのインタラクションは、すべて `/api/interactions` への POST リクエストとして Hono アプリケーションで受け取ります。この単一のルート内で、受け取ったリクエストボディの `data.name` (コマンド名) によって処理を分岐させます。

##### 5.5. 環境変数の利用

Hono のコンテキストオブジェクト `c` を通じて、`wrangler.toml` に設定した環境変数に安全にアクセスできます。

TypeScript

```
const gasUrl = c.env.GAS_WEB_APP_URL;
const allowedChannels = c.env.ALLOWED_CHANNEL_IDS.split(',');
```

##### 5.6. レスポンスの生成

Discord API への応答は、Hono の `.json()` ヘルパーを使用することで簡潔に記述できます。

TypeScript

```
// 応答メッセージを返す例
return c.json({
  type: 4, // InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE
  data: {
    content: '✅ 勤務を開始しました。',
  },
});
```

---

#### 6. 必要な設定値 (環境変数)

**Cloudflare Worker (`wrangler.jsonc`):**

プロジェクトでは `wrangler.jsonc` ファイルを使用します。環境変数は Cloudflare ダッシュボードまたは `wrangler secret` コマンドで設定します。

| 変数名                   | 説明                                                                              |
| :----------------------- | :-------------------------------------------------------------------------------- |
| `DISCORD_PUBLIC_KEY`     | Discord Application の公開鍵。                                                    |
| `DISCORD_APPLICATION_ID` | Discord Application の ID。                                                       |
| `DISCORD_TOKEN`          | Discord Bot のトークン。                                                          |
| `GAS_WEB_APP_URL`        | デプロイした GAS Web App の URL。                                                 |
| `ALLOWED_CHANNEL_IDS`    | コマンド実行を許可するチャンネル ID のリスト。(カンマ区切り文字列: `id1,id2,id3`) |

**KV Namespace 設定:**

重複チェック用の Cloudflare KV ネームスペースも設定が必要です。

| 設定項目  | 値                   | 説明                                        |
| :-------- | :------------------- | :------------------------------------------ |
| `binding` | `KINTAI_DISCORD_KV`  | TypeScript コードで参照するバインディング名 |
| `id`      | (作成時に生成される) | Cloudflare KV ネームスペースの実際の ID     |

**Google Apps Script (スクリプトプロパティ):**

| 変数名           | 説明                                          |
| :--------------- | :-------------------------------------------- |
| `SPREADSHEET_ID` | 勤怠を記録する Google スプレッドシートの ID。 |

環境変数の設定は `wrangler secret put <KEY>` コマンドを使用します。
