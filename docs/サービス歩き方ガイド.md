# ğŸ—ºï¸ Discordå‹¤æ€ ç®¡ç†Bot ã‚µãƒ¼ãƒ“ã‚¹æ­©ãæ–¹ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Discordå‹¤æ€ ç®¡ç†Botã‚µãƒ¼ãƒ“ã‚¹ã®æŠ€è¡“çš„ãªä»•çµ„ã¿ã¨å…¨ä½“çš„ãªæµã‚Œã‚’è©³ç´°ã«èª¬æ˜ã™ã‚‹ç·åˆã‚¬ã‚¤ãƒ‰ã§ã™ã€‚é–‹ç™ºè€…ã€é‹ç”¨è€…ã€ãã—ã¦å¥½å¥‡å¿ƒæ—ºç››ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒã©ã®ã‚ˆã†ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ã‚’ç†è§£ã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸ¯ ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦

### ä½•ã‚’ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‹

**Discordå‹¤æ€ ç®¡ç†Bot**ã¯ã€Discordã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦å‹¤æ€ è¨˜éŒ²ã‚’è¡Œã„ã€å„ã‚µãƒ¼ãƒãƒ¼å°‚ç”¨ã®Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

### æ ¸å¿ƒçš„ãªä¾¡å€¤ææ¡ˆ

- **ç°¡å˜**: `/start` ã¨ `/end` ã ã‘ã§å‹¤æ€ è¨˜éŒ²å®Œäº†
- **å®‰å…¨**: å„ã‚µãƒ¼ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«åˆ†é›¢ã•ã‚Œã€ç®¡ç†è€…ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä¿å­˜
- **è‡ªå‹•**: åŠ´åƒæ™‚é–“ã®è¨ˆç®—ã€æœˆåˆ¥ã‚·ãƒ¼ãƒˆä½œæˆã€ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã¹ã¦è‡ªå‹•åŒ–
- **é€æ˜**: ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§æŠ€è¡“çš„ãªä»•çµ„ã¿ãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ä¸€è¦§

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ | å½¹å‰² |
|---------|------|------|
| **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰** | Discord UI | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ |
| **API Gateway** | Discord API | ã‚³ãƒãƒ³ãƒ‰å—ä¿¡ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ |
| **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³** | Cloudflare Workers + Hono | ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯å‡¦ç† |
| **èªè¨¼** | OAuth 2.0 | Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | Google Spreadsheet | å‹¤æ€ ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥** | Cloudflare KV | çŠ¶æ…‹ç®¡ç†ãƒ»æš—å·åŒ–ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | AES-256-GCMæš—å·åŒ– | ãƒˆãƒ¼ã‚¯ãƒ³æš—å·åŒ– |

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```
[Discord User] 
    â†“ /start, /end, /setup
[Discord API]
    â†“ Webhook
[Cloudflare Workers (Hono)]
    â†“ 
[Cloudflare KV] â† é‡è¤‡ãƒã‚§ãƒƒã‚¯ãƒ»æš—å·åŒ–ãƒˆãƒ¼ã‚¯ãƒ³
    â†“
[Google Sheets API]
    â†“
[Google Spreadsheet (ã‚µãƒ¼ãƒãƒ¼å°‚ç”¨)]
```

---

## ğŸ”„ æŠ€è¡“ãƒ•ãƒ­ãƒ¼è©³ç´°è§£èª¬

### 1. åˆæœŸè¨­å®šãƒ•ãƒ­ãƒ¼ (`/setup`)

#### Phase 1: æ¨©é™ç¢ºèªã¨åˆæœŸåŒ–
```typescript
1. Discord -> Cloudflare Workers
   - ã‚³ãƒãƒ³ãƒ‰å—ä¿¡: `/setup`
   - ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯ (Discord API)
   - æ—¢å­˜è¨­å®šç¢ºèª (Cloudflare KV)
```

#### Phase 2: OAuthæº–å‚™
```typescript
2. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰URLç”Ÿæˆ
   - ä¸€æ„ã®èªè¨¼çŠ¶æ…‹ (state) ã‚’Crypto.randomUUID()ã§ç”Ÿæˆ
   - KVã«ä¸€æ™‚ä¿å­˜: `oauth_state:{state}` (10åˆ†TTL)
   - ã‚¬ã‚¤ãƒ‰ãƒšãƒ¼ã‚¸URLç”Ÿæˆ: `/setup-guide?guild={guildId}&state={state}`
```

#### Phase 3: Google Cloudè¨­å®š (ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ)
```typescript
3. ç®¡ç†è€…ãŒGoogle Cloud Projectä½œæˆ
   - Google Cloud Console ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
   - Google Sheets API + Google Drive API æœ‰åŠ¹åŒ–
   - OAuth 2.0 èªè¨¼æƒ…å ±ä½œæˆ (Web Application)
   - ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIè¨­å®š: bot-domain.workers.dev/oauth/callback
```

#### Phase 4: OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼
```typescript
4. èªè¨¼æƒ…å ±å…¥åŠ›ã¨OAuthå®Ÿè¡Œ
   - Client ID + Client Secret å…¥åŠ› -> æš—å·åŒ–ã—ã¦KVã«ä¸€æ™‚ä¿å­˜
   - Google OAuth URL ç”Ÿæˆ: accounts.google.com/o/oauth2/auth
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒGoogleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼
   - èªè¨¼ã‚³ãƒ¼ãƒ‰å–å¾—: GET /oauth/callback?code=xxx&state=xxx
```

#### Phase 5: ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ
```typescript
5. èªè¨¼ã‚³ãƒ¼ãƒ‰ -> ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›
   - POST oauth2.googleapis.com/token
   - ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ + ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
   
6. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè‡ªå‹•ä½œæˆ
   - POST sheets.googleapis.com/v4/spreadsheets
   - ã‚¿ã‚¤ãƒˆãƒ«: "å‹¤æ€ ãƒ­ã‚°ç®¡ç†_kintai-discord"
   - ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå, ãƒ¦ãƒ¼ã‚¶ãƒ¼å, å·®åˆ†, é–‹å§‹æ™‚åˆ», çµ‚äº†æ™‚åˆ», etc
   
7. è¨­å®šä¿å­˜ (æš—å·åŒ–)
   - ãƒˆãƒ¼ã‚¯ãƒ³ã‚’AES-256-GCMã§æš—å·åŒ–
   - KVã«ä¿å­˜: `server:{guildId}` (æ°¸ç¶š)
```

### 2. å‹¤å‹™é–‹å§‹ãƒ•ãƒ­ãƒ¼ (`/start`)

#### Phase 1: äº‹å‰ãƒã‚§ãƒƒã‚¯
```typescript
1. Discord -> Cloudflare Workers
   - Deferred Response å³åº§ã«è¿”å´ (100msä»¥å†…)
   - ã‚µãƒ¼ãƒãƒ¼è¨­å®šå–å¾—: KV `server:{guildId}`
   - ãƒˆãƒ¼ã‚¯ãƒ³å¾©å·åŒ–: AES-256-GCM decrypt
   
2. é‡è¤‡ãƒã‚§ãƒƒã‚¯ (é«˜é€Ÿ)
   - KVç¢ºèª: `{userId}:{channelId}`
   - æ—¢å­˜è¨˜éŒ²ãŒã‚ã‚Œã°å‡¦ç†åœæ­¢
```

#### Phase 2: Google Sheetsè¨˜éŒ²
```typescript
3. æœˆåˆ¥ã‚·ãƒ¼ãƒˆç¢ºèªãƒ»ä½œæˆ
   - ã‚·ãƒ¼ãƒˆå: YYYY-MM (ä¾‹: 2025-06)
   - å­˜åœ¨ã—ãªã„å ´åˆã¯è‡ªå‹•ä½œæˆ
   
4. å‹¤æ€ é–‹å§‹è¨˜éŒ²
   - UUIDç”Ÿæˆ: crypto.randomUUID()
   - ãƒ‡ãƒ¼ã‚¿ä½œæˆ: [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå, ãƒ¦ãƒ¼ã‚¶ãƒ¼å, "", é–‹å§‹æ™‚åˆ», "", channelId, userId, uuid]
   - POST sheets.googleapis.com/v4/spreadsheets/{id}/values/{range}:append
```

#### Phase 3: çŠ¶æ…‹ä¿å­˜ã¨é€šçŸ¥
```typescript
5. KVçŠ¶æ…‹ä¿å­˜
   - ã‚­ãƒ¼: `{userId}:{channelId}`
   - å€¤: { startTime, uuid, username, channelName, projectName }
   - TTL: 24æ™‚é–“ (è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—)
   
6. Discordé€šçŸ¥
   - æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "âœ… å‹¤å‹™ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼"
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåè¡¨ç¤º
```

### 3. å‹¤å‹™çµ‚äº†ãƒ•ãƒ­ãƒ¼ (`/end`)

#### Phase 1: é–‹å§‹è¨˜éŒ²ç¢ºèª
```typescript
1. Discord -> Cloudflare Workers  
   - Deferred Response å³åº§ã«è¿”å´
   - ã‚µãƒ¼ãƒãƒ¼è¨­å®šå–å¾—ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³å¾©å·åŒ–
   
2. é–‹å§‹è¨˜éŒ²æ¤œç´¢
   - Google Sheets APIã§UUIDæ¤œç´¢
   - è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¡Œç•ªå·ç‰¹å®š
   - é–‹å§‹æ™‚åˆ»ã¨ã®æ•´åˆæ€§ç¢ºèª
```

#### Phase 2: åŠ´åƒæ™‚é–“è¨ˆç®—ã¨è¨˜éŒ²
```typescript
3. çµ‚äº†æ™‚åˆ»è¨˜éŒ²
   - ç¾åœ¨æ™‚åˆ» or æŒ‡å®šæ™‚åˆ»
   - ã‚»ãƒ«æ›´æ–°: Eåˆ— (çµ‚äº†æ™‚åˆ»)
   - å·®åˆ†è‡ªå‹•è¨ˆç®—: Google Sheetsæ•°å¼ã§è‡ªå‹•è¨ˆç®—

4. åŠ´åƒæ™‚é–“å–å¾—
   - è¨ˆç®—çµæœã‚’APIã§å–å¾—
   - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: "8æ™‚é–“30åˆ†"
```

#### Phase 3: çŠ¶æ…‹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¨é€šçŸ¥
```typescript
5. KVçŠ¶æ…‹å‰Šé™¤
   - `{userId}:{channelId}` ã‚­ãƒ¼å‰Šé™¤
   - é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
   
6. Discordé€šçŸ¥
   - å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "âœ… å‹¤å‹™ã‚’çµ‚äº†ã—ã¾ã—ãŸï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼"
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå + åŠ´åƒæ™‚é–“è¡¨ç¤º
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒ­ãƒ¼

### 1. Discordç½²åæ¤œè¨¼

```typescript
// å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å®Ÿè¡Œ
function verifyDiscordRequest(request, publicKey) {
  const signature = request.headers.get('x-signature-ed25519');
  const timestamp = request.headers.get('x-signature-timestamp');
  const body = request.body;
  
  // Ed25519ç½²åæ¤œè¨¼
  return crypto.subtle.verify(
    "Ed25519",
    publicKey,
    hexToArrayBuffer(signature),
    new TextEncoder().encode(timestamp + body)
  );
}
```

### 2. ãƒˆãƒ¼ã‚¯ãƒ³æš—å·åŒ–ã‚·ã‚¹ãƒ†ãƒ 

```typescript
// AES-256-GCMæš—å·åŒ–
class CryptoService {
  async encrypt(data: string): Promise<string> {
    const key = await crypto.subtle.importKey(
      "raw",
      new TextEncoder().encode(this.encryptionKey), // 32æ–‡å­—
      { name: "AES-GCM" },
      false,
      ["encrypt"]
    );
    
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encrypted = await crypto.subtle.encrypt(
      { name: "AES-GCM", iv },
      key,
      new TextEncoder().encode(data)
    );
    
    // IV + æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    const result = new Uint8Array(iv.length + encrypted.byteLength);
    result.set(iv);
    result.set(new Uint8Array(encrypted), iv.length);
    return btoa(String.fromCharCode(...result));
  }
}
```

### 3. ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```typescript
// ã‚µãƒ¼ãƒãƒ¼åˆ¥å®Œå…¨ãƒ‡ãƒ¼ã‚¿åˆ†é›¢
const dataIsolation = {
  kvKeys: {
    serverConfig: `server:{guildId}`,      // ã‚µãƒ¼ãƒãƒ¼è¨­å®š
    attendanceState: `{userId}:{channelId}`, // å‹¤æ€ çŠ¶æ…‹
    oauthState: `oauth_state:{state}`       // OAuthä¸€æ™‚çŠ¶æ…‹
  },
  
  spreadsheetAccess: {
    ownership: "å„ã‚µãƒ¼ãƒãƒ¼ç®¡ç†è€…ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆ",
    isolation: "Guild IDãƒ™ãƒ¼ã‚¹ã§å®Œå…¨åˆ†é›¢",
    permissions: "Boté–‹ç™ºè€…ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯"
  }
};
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ§‹é€ è©³ç´°

### 1. Cloudflare KVæ§‹é€ 

#### ã‚µãƒ¼ãƒãƒ¼è¨­å®š (æš—å·åŒ–æ¸ˆã¿)
```typescript
// ã‚­ãƒ¼: server:{guildId}
{
  "spreadsheet_id": "1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms",
  "encrypted_tokens": "base64-encoded-encrypted-data",
  "sheet_url": "https://docs.google.com/spreadsheets/d/...",
  "owner_id": "123456789012345678",
  "created_at": "2025-06-28T12:00:00Z"
}
```

#### å‹¤æ€ çŠ¶æ…‹ (24æ™‚é–“TTL)
```typescript
// ã‚­ãƒ¼: {userId}:{channelId}
{
  "startTime": "2025-06-28T09:00:00.000Z",
  "uuid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "username": "user123",
  "channelName": "general",
  "projectName": "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå"
}
```

### 2. Google Spreadsheetæ§‹é€ 

#### æœˆåˆ¥ã‚·ãƒ¼ãƒˆå½¢å¼ (YYYY-MM)
| A | B | C | D | E | F | G | H |
|---|---|---|---|---|---|---|---|
| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå | ãƒ¦ãƒ¼ã‚¶ãƒ¼å | å·®åˆ† | é–‹å§‹æ™‚åˆ» | çµ‚äº†æ™‚åˆ» | channel_id | discord_id | uuid |
| general | user123 | 8æ™‚é–“30åˆ† | 2025/06/28 09:00:00 | 2025/06/28 17:30:00 | 123456 | 987654 | uuid-xxx |

#### è‡ªå‹•è¨ˆç®—å¼
```
C2: =IF(AND(D2<>"", E2<>""), TEXT(E2-D2, "[h]æ™‚é–“måˆ†"), "")
```

---

## ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### 1. å¿œç­”æ™‚é–“è¨­è¨ˆ

| æ“ä½œ | ç›®æ¨™å¿œç­”æ™‚é–“ | å®Ÿè£…æ–¹å¼ |
|------|-------------|----------|
| ã‚³ãƒãƒ³ãƒ‰å—ä¿¡ | 100msä»¥å†… | Deferred Response |
| é‡è¤‡ãƒã‚§ãƒƒã‚¯ | 50msä»¥å†… | Cloudflare KV |
| ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–° | 1-3ç§’ | Google Sheets API |
| æš—å·åŒ–ãƒ»å¾©å·åŒ– | 10msä»¥å†… | Web Crypto API |

### 2. ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ

```typescript
const scalabilityDesign = {
  concurrentUsers: "ç†è«–ä¸Šç„¡åˆ¶é™ (Cloudflare Workers)",
  simultaneousServers: "ç„¡åˆ¶é™ (Guild IDåˆ†é›¢)",
  kvOperations: "10M requests/month (Cloudflare KV)",
  googleApiLimits: "100 requests/100sec/user (Google Sheets)",
  
  optimizations: [
    "KVã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹é«˜é€Ÿã‚¢ã‚¯ã‚»ã‚¹",
    "ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š",
    "è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ (æœ€å¤§3å›, æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•)",
    "24æ™‚é–“TTLã«ã‚ˆã‚‹è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
  ]
};
```

### 3. éšœå®³å¯¾å¿œè¨­è¨ˆ

```typescript
const errorHandling = {
  networkFailure: "æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ + æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•",
  googleApiError: "ãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ + ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯",
  kvAccessError: "ä»£æ›¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‘ã‚¹ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼é€šçŸ¥",
  discordApiError: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰åˆ¥ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"
};
```

---

## ğŸ› ï¸ é–‹ç™ºãƒ»é‹ç”¨ãƒ•ãƒ­ãƒ¼

### 1. é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ­ãƒ¼ãƒ³
git clone <repository>
cd kintai-discord-v2

# 2. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
bun install

# 3. ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .env.example .dev.vars
# Discordè¨­å®šã¨ENCRYPTION_KEYã‚’è¨­å®š

# 4. Cloudflare KVä½œæˆ
bun run kv:setup

# 5. Discord ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²
bun run register-commands

# 6. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
bun run dev
```

### 2. æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

```bash
# 1. å‹ãƒã‚§ãƒƒã‚¯
bun run tsc --noEmit

# 2. KVè¨­å®šç¢ºèª
bun run cf-typegen

# 3. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š
bun run secrets:setup

# 4. æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
bun run deploy

# 5. å‹•ä½œç¢ºèª
wrangler tail  # ãƒ­ã‚°ç›£è¦–
```

### 3. ç›£è¦–ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

```typescript
const monitoring = {
  metrics: [
    "å¿œç­”æ™‚é–“ (Cloudflare Analytics)",
    "ã‚¨ãƒ©ãƒ¼ç‡ (Worker logs)",
    "APIä½¿ç”¨é‡ (Google Cloud Console)",
    "KVä½¿ç”¨é‡ (Cloudflare Dashboard)"
  ],
  
  alerts: [
    "ã‚¨ãƒ©ãƒ¼ç‡ > 5%",
    "å¿œç­”æ™‚é–“ > 10ç§’", 
    "APIåˆ¶é™åˆ°é”",
    "KVã‚¯ã‚©ãƒ¼ã‚¿è­¦å‘Š"
  ],
  
  maintenance: [
    "å®šæœŸçš„ãªãƒ­ã‚°ç¢ºèª",
    "æš—å·åŒ–ã‚­ãƒ¼ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»",
    "Google APIã‚¯ã‚©ãƒ¼ã‚¿ç›£è¦–",
    "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé©ç”¨"
  ]
};
```

---

## ğŸ¯ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒƒãƒ—

### ã‚ˆãã‚ã‚‹å•é¡Œã¨æŠ€è¡“çš„è§£æ±ºç­–

#### 1. OAuthèªè¨¼ã‚¨ãƒ©ãƒ¼
```
ç—‡çŠ¶: "redirect_uri_mismatch"
åŸå› : Google Cloud Consoleã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIè¨­å®šãƒŸã‚¹
è§£æ±º: https://bot-domain.workers.dev/oauth/callback ã‚’æ­£ç¢ºã«è¨­å®š
æŠ€è¡“: OAuth 2.0ä»•æ§˜ã«å¾“ã£ãŸå³å¯†ãªURIä¸€è‡´ãƒã‚§ãƒƒã‚¯
```

#### 2. ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²å¤±æ•—
```
ç—‡çŠ¶: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã•ã‚Œãªã„
åŸå› : ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ or APIæ¨©é™ä¸è¶³
è§£æ±º: è‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ + æ¨©é™å†ç¢ºèª
æŠ€è¡“: OAuth 2.0 refresh_tokenã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°
```

#### 3. é‡è¤‡ãƒã‚§ãƒƒã‚¯å¤±æ•—
```
ç—‡çŠ¶: äºŒé‡æ‰“åˆ»ãŒç™ºç”Ÿ
åŸå› : KVã‚¢ã‚¯ã‚»ã‚¹éšœå®³ or TTLè¨­å®šå•é¡Œ
è§£æ±º: KVçŠ¶æ…‹ç¢ºèª + ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
æŠ€è¡“: Cloudflare KVåˆ†æ•£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç†è§£
```

### ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ç›£è¦–
wrangler tail

# KVçŠ¶æ…‹ç¢ºèª
wrangler kv:key list --namespace-id="your-kv-id"

# è¨­å®šçŠ¶æ³ç¢ºèª (Discordå†…)
/config

# å‹å®šç¾©å†ç”Ÿæˆ
bun run cf-typegen
```

---

## ğŸ“ˆ ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

### Phase 1: æ©Ÿèƒ½æ‹¡å¼µ
- å‹¤å‹™çŠ¶æ³ç¢ºèªã‚³ãƒãƒ³ãƒ‰ (`/config user`)
- æ™‚é–“ç¯„å›²æŒ‡å®šè¨˜éŒ² (`/add 19:00 21:00`)
- è‡ªå‹•é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  (æ‰“åˆ»å¿˜ã‚Œã‚¢ãƒ©ãƒ¼ãƒˆ)

### Phase 2: ã‚¤ãƒ³ãƒ•ãƒ©å¼·åŒ–
- è¤‡æ•°ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œ
- Redisä»£æ›¿ã¨ã—ã¦ã®Durable Objectsæ´»ç”¨
- GraphQL APIåŒ–

### Phase 3: é«˜åº¦ãªæ©Ÿèƒ½
- AI ã«ã‚ˆã‚‹å‹¤å‹™ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
- Slacké€£æº
- ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªå¯¾å¿œ

---

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

### æŠ€è¡“çš„è²¢çŒ®é ˜åŸŸ

1. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: Cloudflare Workers + Honoæœ€é©åŒ–
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: æš—å·åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æ”¹å–„
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: KVä½¿ç”¨é‡æœ€é©åŒ–
4. **APIè¨­è¨ˆ**: Google Sheets APIåŠ¹ç‡åŒ–
5. **ç›£è¦–**: å¯è¦³æ¸¬æ€§å‘ä¸Š

### é–‹ç™ºå‚åŠ æ–¹æ³•

```bash
# 1. Fork & Clone
git clone https://github.com/your-username/kintai-discord-v2.git

# 2. æ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
git checkout -b feature/your-feature-name

# 3. é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆ
bun run dev
bun run test  # ãƒ†ã‚¹ãƒˆå®Ÿè£…ä¸­

# 4. PRä½œæˆ
# æŠ€è¡“çš„ãªå¤‰æ›´ç‚¹ã¨å½±éŸ¿ç¯„å›²ã‚’æ˜è¨˜
```

---

## ğŸ“š å‚è€ƒæŠ€è¡“æ–‡æ›¸

### å†…éƒ¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰](./ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰.md)
- [ç›´æ¥OAuthæ–¹å¼è¨­å®šã‚¬ã‚¤ãƒ‰](./ç›´æ¥OAuthæ–¹å¼è¨­å®šã‚¬ã‚¤ãƒ‰.md)
- [Boté‹ç”¨è€…å‘ã‘ã‚¬ã‚¤ãƒ‰](./Boté‹ç”¨è€…å‘ã‘ã‚¬ã‚¤ãƒ‰.md)
- [å‹¤æ€ ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæŒ‡ç¤ºæ›¸](./å‹¤æ€ ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæŒ‡ç¤ºæ›¸.md)

### å¤–éƒ¨æŠ€è¡“è³‡æ–™
- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/)
- [Hono Framework](https://hono.dev/)
- [Google Sheets API v4](https://developers.google.com/sheets/api)
- [Discord API Documentation](https://discord.com/developers/docs)
- [OAuth 2.0 RFC](https://tools.ietf.org/html/rfc6749)

---

## ğŸ¯ ã¾ã¨ã‚

ã“ã®Discordå‹¤æ€ ç®¡ç†Botã¯ã€**ç¾ä»£çš„ãªã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã¨**ã‚»ã‚­ãƒ¥ã‚¢ãªOAuth 2.0èªè¨¼**ã‚’çµ„ã¿åˆã‚ã›ãŸã€**ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§å®‰å…¨ãªå‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **ã§ã™ã€‚

### æŠ€è¡“çš„ãƒã‚¤ãƒ©ã‚¤ãƒˆ

1. **Cloudflare Workers**: ã‚¨ãƒƒã‚¸ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ã‚ˆã‚‹ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼
2. **Hono Framework**: TypeScript-firstã®å‹å®‰å…¨ãªAPIé–‹ç™º
3. **ç›´æ¥OAuthæ–¹å¼**: ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦–ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
4. **AES-256-GCMæš—å·åŒ–**: é‡‘èã‚°ãƒ¬ãƒ¼ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
5. **Google Sheets API**: ä½¿ã„æ…£ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†

### ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤

- **ğŸš€ å³åº§ã«ä½¿ãˆã‚‹**: 5åˆ†ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†
- **ğŸ”’ å®Œå…¨ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ**: ãƒ‡ãƒ¼ã‚¿ã¯å„ã‚µãƒ¼ãƒãƒ¼ç®¡ç†è€…ãŒç®¡ç†
- **ğŸ“Š è¦‹ãˆã‚‹åŒ–**: Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ API
- **ğŸ’° ã‚³ã‚¹ãƒˆåŠ¹ç‡**: åŸºæœ¬çš„ã«ç„¡æ–™ã§é‹ç”¨å¯èƒ½
- **ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½**: ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§æ‹¡å¼µè‡ªç”±

**Happy tracking! ğŸ“ˆ**

---

*æœ€çµ‚æ›´æ–°: 2025å¹´6æœˆ28æ—¥*  
*ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v2.0 (ç›´æ¥OAuthæ–¹å¼)*  
*æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: Cloudflare Workers + Hono + Google Sheets API*
